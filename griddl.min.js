/*!
 * griddl
 * Version: 0.8.3
 * Build Date: 2014-02-02
 * Copyright (c) 2014 Glenn Britting
 */
var griddl=griddl||{};griddl.version="0.8.3",griddl.sortType={NO_SORTING:0,STRING:1,INT:2,FLOAT:3,DATE:4,BOOL:5},griddl.columnSortOrder={NONE:0,ASC:1,DESC:2},griddl.Column=function(a,b,c,d,e){this.fieldName=a,this.displayName=b,this.sorter=d||(0===d?d:griddl.sortType.STRING),this.formatter=e,this.width=c||0,this.currentSortOrder=griddl.columnSortOrder.NONE},griddl.Column.prototype.getIsSortable=function(){return this.sorter!==griddl.sortType.NO_SORTING},griddl.Column.prototype.getIsCurrentlyAscending=function(){return this.currentSortOrder===griddl.columnSortOrder.ASC},griddl.Column.prototype.switchSortOrder=function(){this.currentSortOrder=this.currentSortOrder===griddl.columnSortOrder.NONE?griddl.columnSortOrder.ASC:this.getIsCurrentlyAscending()?griddl.columnSortOrder.DESC:griddl.columnSortOrder.ASC},griddl.formatter={bool:function(a){return a?"Yes":"No"}},griddl.Grid=function(a,b){var c,d=a;this.containerSelector=a,this.settings={keyField:"",selectableRows:!1,perPage:10,columns:[],showFooter:!0,showPageInfo:!0,showPerPage:!0,showPager:!0,searcher:function(){return!1},onSort:function(){},onRowSelect:function(){},onPerPageChange:function(){},onPagerPage:function(){},onInit:function(){}},$.extend(this.settings,b),this.displayInfo="",this.firstShownIndex=0,this.rowCount=0,this.currentPage=0,this.data=[],this._originalData=[],this.getContainer=function(){return c||(c=$(d)),c}},griddl.Grid.prototype.search=function(a){var b=[],c=a.replace(/^\s+|\s+$/gm,"");this._originalData.length>0&&(this.data=this._originalData,this._originalData=[]);for(var d=0;d<this.data.length;d++){var e=this.data[d];this.settings.searcher(e,c)&&b.push(e)}return b.length>0&&(this._originalData=this.data,this.data=b,this.page(1)),b.length},griddl.Grid.prototype.clearSearch=function(){this._originalData.length>0&&(this.data=this._originalData,this._originalData=[]),this.page(1)},griddl.Grid.prototype.generateColumns=function(a){var b,c,d,e=[];if("undefined"==typeof a){c=this.data[0];for(var f in c)c.hasOwnProperty(f)&&e.push(f)}else e=a;for(b=0;b<e.length;b++)d=e[b],this.settings.columns.push(new griddl.Column(d,d.charAt(0).toUpperCase()+d.slice(1)))},griddl.Grid.prototype.page=function(a){var b,c,d,e="",f="",g=0,h=this.settings,i=h.columns,j=this.getContainer(),k=(a-1)*h.perPage;if(!this._hasBeenRendered)throw"griddl: You must call render before you call page.";if(!(1>a||a>griddl.pager.calcMaxPage(this.data.length,h.perPage))){this.rowCount=this.data.length,this.firstShownIndex=k+1,this.currentPage=a;for(var l=k;l<k+h.perPage;l++){if(l>=this.rowCount)c=l===this.rowCount?"gdl-row-empty gdl-first":"gdl-row-empty",e+='<tr class="'+c+'"><td colspan="'+i.length+'">&nbsp;</td>';else{b=this.data[l],e+=h.selectableRows?h.keyField?'<tr class="gdl-row-selectable" data-gdl-key="'+b[h.keyField]+'">':'<tr class="gdl-row-selectable">':"<tr>";for(var m=0;m<i.length;m++)f="function"==typeof i[m].formatter?i[m].formatter(b):i[m].sorter===griddl.sortType.BOOL?griddl.formatter.bool(b[i[m].fieldName]):b[i[m].fieldName],d="gdl-col-"+m,e+='<td class="'+d+'">'+f+"</td>";g++}e+="</tr>"}j.find(".gdl-table > tbody").empty().html(e),this.displayInfo=this.firstShownIndex.toLocaleString()+" - "+(this.firstShownIndex+g-1).toLocaleString()+" of "+this.rowCount.toLocaleString(),h.showFooter&&(h.showPageInfo&&j.find(".gdl-panel-info").text(this.displayInfo),h.showPager&&griddl.pager.reset(j.find(".gdl-pager"),a,this.rowCount,h.perPage))}},griddl.Grid.prototype.render=function(a){function b(){for(var a,b,c="",d="",e="",f=0;f<h.length;f++)a=h[f],c+=h[f].width?'<col style="width:'+h[f].width+'%;" >':"<col>",b="gdl-col-"+f,a.getIsSortable()&&(b+=" gdl-col-sortable",a.currentSortOrder!==griddl.columnSortOrder.NONE&&(b+=a.getIsCurrentlyAscending()?" gdl-ascending":" gdl-descending")),d+='<th class="'+b+'"><span>'+a.displayName+"</span></th>";return g.settings.showFooter&&(e='<tfoot><tr><td colspan="'+h.length+'"><div class="gdl-panel-pager">',g.settings.showPager&&(e+=griddl.pager.shell),e+='</div><div class="gdl-panel-perPage">',g.settings.showPerPage&&(e+=griddl.perPage.build(g.settings.perPage)),e+='</div><div class="gdl-panel-info"></div></td></td></tr></tfoot>'),'<div class="gdl-content"><table class="gdl-table"><colgroup>'+c+"</colgroup><thead><tr>"+d+"</tr></thead>"+e+"<tbody></tbody></table></div>"}function c(a){a.switchSortOrder()}function d(a){a.sorter===griddl.sortType.INT?griddl.sorter.byInt(g.data,a.fieldName,a.getIsCurrentlyAscending()):a.sorter===griddl.sortType.FLOAT?griddl.sorter.byFloat(g.data,a.fieldName,a.getIsCurrentlyAscending()):a.sorter===griddl.sortType.DATE?griddl.sorter.byDate(g.data,a.fieldName,a.getIsCurrentlyAscending()):"function"==typeof a.sorter?g.data.sort(a.sorter(a.getIsCurrentlyAscending())):griddl.sorter.byString(g.data,a.fieldName,a.getIsCurrentlyAscending())}function e(a,b){var c=g.getContainer(),d=c.find("th");d.removeClass("gdl-ascending gdl-descending"),d.eq(b).addClass(function(){return a.getIsCurrentlyAscending()?"gdl-ascending":"gdl-descending"})}var f,g=this,h=this.settings.columns;if(this._hasBeenRendered)throw"griddl: You can only call render once per grid. If you want to load new data to an existing grid, set grid.data, and then call grid.page(1).";if(!jQuery.isArray(a))throw"griddl: data parameter must be an [] of model objects.";this._hasBeenRendered=!0,g.data=a,0===this.settings.columns.length&&this.generateColumns(),f=b(),$(function(){var a=g.getContainer();a.prepend(f),g.settings.onInit(g.data.length),g.page(1),g.settings.selectableRows&&a.find(".gdl-table > tbody").on("click","tr",function(){var a=$(this),b=a.data("gdl-key");a.parent().find("tr").removeClass("gdl-row-selected"),a.addClass("gdl-row-selected"),g.settings.onRowSelect(b)}),g.settings.showFooter&&(g.settings.showPager&&a.find(".gdl-pager").on("click","li",function(){var a=$(this),b=1;a.hasClass("gdl-button-enabled")&&(b=parseInt(a.attr("data-number"),10),-1===b&&(b=griddl.pager.calcMaxPage(g.data.length,g.settings.perPage)),g.page(b),g.settings.onPagerPage(b))}),g.settings.showPerPage&&a.find(".gdl-panel-perPage select").on("change",function(){var a=parseInt($(this).val(),10);g.settings.perPage=a,g.page(1),g.settings.onPerPageChange(a)})),a.find(".gdl-table th").on("click",function(){var a=$(this).index(),b=h[a];b.getIsSortable()&&(c(b),d(b),g.page(1),g.settings.onSort(b),e(b,a))})})},griddl.pager={shell:'<ul class="gdl-pager"><li data-number="1">First</li><li>Prev</li><li>Next</li><li data-number="-1">Last</li></ul>',calcMaxPage:function(a,b){return Math.ceil(a/b)},reset:function(a,b,c,d){var e=a.find("li").removeClass("gdl-button-enabled"),f=parseInt(b,10),g=this.calcMaxPage(c,d);1===f&&1===g?e.removeClass("gdl-button-enabled"):1===f?e.filter(":gt(1)").addClass("gdl-button-enabled"):f>=g?e.filter(":lt(2)").addClass("gdl-button-enabled"):e.addClass("gdl-button-enabled"),e.eq(1).attr("data-number",f-1),e.eq(2).attr("data-number",f+1)}},griddl.perPage={options:[10,20,50],build:function(a){for(var b,c="<select>",d=0;d<this.options.length;d++)b=this.options[d]===a?' selected="selected"':"",c+='<option value="'+this.options[d]+'"'+b+">"+this.options[d]+"</option>";return c+"</select> per page"}},griddl.sorter={sortBy:function(a,b,c){var d=function(b){return c?c(b[a]):b[a]};return function(a,c){var e=d(a),f=d(c);return(f>e?-1:e>f?1:0)*[-1,1][+!!b]}},byString:function(a,b,c){a.sort(this.sortBy(b,c,function(a){return"string"!=typeof a?a.toString().toUpperCase():a.toUpperCase()}))},byFloat:function(a,b,c){a.sort(this.sortBy(b,c,parseFloat))},byInt:function(a,b,c){a.sort(this.sortBy(b,c,parseInt))},byDate:function(a,b,c){a.sort(this.sortBy(b,c,function(a){return new Date(a)}))}};